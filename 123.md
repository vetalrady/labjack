# Serial Data Programming

## Example — Typical BASIC Language Message

```
OUTPUT 10; "AC10VD4"
```

- **Protocol:** `OUTPUT`
- **ISC:** `10;`
- **Commands:** `"AC10VD4"`

## Message Syntax

Before a command can be accepted by the 3497A, it must first get across the interface and then be accepted as valid by the 3497A. We'll talk later about getting the message across the interface. First, let's list some punctuation (syntax) rules for commands to be accepted as valid by the 3497A.

### 3497A Command Syntax Rules

1. Each command must begin with two upper case letters and may be followed by one or more numerics. The 3497A ignores lower case letters, LF (Line Feed), colon (:), the plus (+) sign, spaces, nulls and ASCII characters between 18 and 31 (decimal).
2. The 3497A recognizes the minus (-) sign only as the first character following an AO (Analog Output) or System View (SV) command. The 3497A recognizes the decimal point as the first character following the SV command.
3. When numbers are used in a command, they must be free field integers from 0 to 9999999999. When numbers are required in a command but are not specified, a "0" is assumed, except for the AC, AV, DV, SR, TD and TE commands. For example, if the command `DC2,3` (close digital channel 3 in slot 2) is intended, but `DC2` is sent, the action is `DC2,0` (close digital channel 0 in slot 2).
4. If more than one number is used in a command, comma(s) must be used between numbers (i.e. `AC3,13`). DON'T use commas anywhere else in the commands, such as between two commands in a message (`AC10VD4` shown previously). In some commands, a comma as the last character is interpreted as a 0. In other commands, a comma as the last character causes any previous commands to be executed and generates an error message.
5. Several commands can be grouped together and sent in a single message. The 3497A executes the commands in the order received by use of the "CR" (Command Terminator) sent with each message. The command string should not exceed 42 characters (excluding the CR terminator). If a command string exceeds 42 characters, execution of commands begins with the 42nd character and all characters after the 42nd are ignored.

## Communicating Over the Bus

As mentioned, communication between your controller and the 3497A takes place over the Serial Data interface bus. Also, as mentioned, we'll divide the discussion on transmitting messages over the bus into three parts: (1) sending commands to the 3497A (2) receiving data from the 3497A and (3) handshake techniques. We'll begin with sending commands to the 3497A.

### Sending Commands to the 3497A

When the controller sends commands to the 3497A, the 3497A is in the receive mode of operation. In this mode, the front panel LISTEN light flashes to indicate information (commands) input to the 3497A. In receive mode, characters are input to a 42-character command buffer until either a CR (command terminator) is received or until the buffer is full (42 characters entered).

After it receives CR, the 3497A executes commands in the order that they are received. If the command string does not exceed 42 characters, the LISTEN light remains on but execution of commands does not start until the CR is received. However, if the command string exceeds 42 characters, execution starts after the buffer is full, even if CR is not sent.

This means that the 43rd and all following command characters will be ignored by the 3497A. Also, command strings exceeding 42 characters will cause the input buffer overflow bit to be set in the 3497A status register (see BREAKS, SERVICE REQUESTS and INTERRUPTS).

Also, if the 3497A is busy executing a command when another is received, the new command will be ignored and the system overrun bit will be set in the status register. Some programming notes for receive mode follow.

### Receiving Data From the 3497A

Certain types of commands require that data be sent from the 3497A to the controller (or other requesting device). When the 3497A sends data to the controller, it is in the transmit mode. When the 3497A is in transmit mode, the front panel TALK light is flashing, indicating that data is being output.

For BASIC language controllers such as the -hp- 85A, the protocol for messages which require data returns is ENTER (i.e., `ENTER 10; A`) which tells the 3497A to send data to the controller and store in A. In response to ENTER messages, the 3497A outputs data in one of three formats (1) ASCII (2) Packed BCD or (3) Time of Day, ASCII, Analog Channel Number.

## Programming Notes for Receive Mode

1. The 3497A does NOT support ECHO. If your controller has this feature, turn the ECHO function OFF before communicating with the 3497A.
2. The 3497A is compatible with even, odd or no parity operation (7-bit ASCII w/odd parity is preset). If parity is not specified, a parity bit is NOT sent and character transmission time is reduced by one bit time.
3. If the front panel LISTEN light does not turn OFF after messages are sent to the 3497A, the controller is probably not sending the CR terminator and CR must be added to each message.
4. To avoid command (input) buffer overflow, do not send messages with command strings which exceed 42 characters.
5. To avoid a system overrun (commands being ignored):
   - a. slow the speed of operation to give the 3497A time to execute commands before sending another command.
   - b. Use WAIT statements in programs to give the 3497A time to execute commands before sending another.
   - c. If the speed of operation can't be slowed down, use a handshake technique. The 3497A is compatible with either DC1 or ENQ/ACK handshakes (see HANDSHAKE TECHNIQUES).

> **NOTE**
>
> The 3497A sends a CR terminator at the end of the data message (LF is NOT sent). Some controllers, including the -hp- 85A, expect to see CR LF at the end of the message. Thus, if your controller normally requires CR LF, you must reconfigure it to eliminate this requirement for proper operation with the 3497A.
>
> A sample way to eliminate the requirement for an LF character is `ENTER 10 USING "#,K"; ...` By using this type of ENTER statement, the -hp- 85A requires only the CR character sent by the 3497A.

## 3497A Data Output Formats

As mentioned, the 3497A outputs data in one of three formats. The formats for ASCII data and Time of Day, ASCII, Analog Channel Number are outlined as follows.

### ASCII Format

The output format for ASCII data from the 3497A is as follows, where D = Decimal digit, O = Octal Digit, 0 = Zeros, E = Exponent and CR is the command terminator (LF is not sent).

#### ASCII Data Output Formats

| Measurement/Value | Output format |
|---|---|
| Voltage Measurement | `± D.DDDDD E±D CR` |
| Time of Day | `DD:DD:DD:DD:DD CR` |
| Elapsed Time | `DDDDDDDDDD CR` (First 4 Digits are Zeroes) |
| Digital Read or Digital Load | `OOOOOO CR` (0-177777 Octal) |
| Digital Interrupt | `OOOOOO CR` (Last 3 digits are 0-377 Octal) |
| Counter Totalize | `DDDDDD CR` |
| Counter Period or Pulse Width | `D.DDDDDD E + D CR` (Seconds) |
| Analog Channel | `± DDD CR` (`-` = No Chan Closed) |
| System Read | `OOOOOO CR` (last 3 digits are 0-377 Octal) |

### Packed BCD Format

Packed BCD is used to increase transfer (reading) speed from the 3497A to the controller. In packed BCD, data is transmitted in three 8-bit bytes, in contrast to ASCII format which requires eleven or more bytes to transmit each measurement to the controller. Option 232 has a storage capacity of 85 readings using packed BCD format. See Chapter 3, HP-IB Programming, for Packed BCD format and example.
